From f5d301e727bf6ed4996b32d51bfc299ae13f18c2 Mon Sep 17 00:00:00 2001
From: JoergZeidler <joerg.zeidler@conplement.de>
Date: Mon, 15 Jan 2024 15:53:11 +0100
Subject: [PATCH] sd notify

---
 .../iothub_communication_manager/CMakeLists.txt      |  3 ++-
 .../src/iothub_communication_manager.c               | 12 ++++++++++++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/src/communication_managers/iothub_communication_manager/CMakeLists.txt b/src/communication_managers/iothub_communication_manager/CMakeLists.txt
index 9707b06..5f47727 100644
--- a/src/communication_managers/iothub_communication_manager/CMakeLists.txt
+++ b/src/communication_managers/iothub_communication_manager/CMakeLists.txt
@@ -29,7 +29,8 @@ target_link_libraries (
             aduc::eis_utils
             aduc::logging
             aduc::retry_utils
-            aduc::url_utils)
+            aduc::url_utils
+            systemd)
 
 target_link_libraries (${target_name} PRIVATE libaducpal)
 
diff --git a/src/communication_managers/iothub_communication_manager/src/iothub_communication_manager.c b/src/communication_managers/iothub_communication_manager/src/iothub_communication_manager.c
index 6397fea..c7c1bae 100644
--- a/src/communication_managers/iothub_communication_manager/src/iothub_communication_manager.c
+++ b/src/communication_managers/iothub_communication_manager/src/iothub_communication_manager.c
@@ -39,6 +39,8 @@
 #include <stdlib.h> // strtol
 #include <sys/stat.h>
 
+#include <systemd/sd-daemon.h>
+
 /**
  * @brief A pointer to ADUC_ClientHandle data. This must be initialize by the component that creates the IoT Hub connection.
  */
@@ -59,6 +61,11 @@ static IOTHUB_CLIENT_DEVICE_TWIN_CALLBACK g_device_twin_callback = NULL;
  */
 static bool g_iothub_client_initialized = false;
 
+/**
+ * @brief A boolean indicates whether the IoT Hub client was once authenticated to iothub.
+ */
+static bool g_iothub_client_authenticated_once = false;
+
 /**
  * @brief An additional data context used the caller.
  */
@@ -215,6 +222,11 @@ void IoTHub_CommunicationManager_ConnectionStatus_Callback(
     case IOTHUB_CLIENT_CONNECTION_AUTHENTICATED:
         g_last_authenticated_time = now_time;
         g_authentication_retries = 0;
+        if (false == g_iothub_client_authenticated_once)
+        {
+            sd_notify(0, "READY=1");
+            g_iothub_client_authenticated_once = true;
+        }
         break;
     case IOTHUB_CLIENT_CONNECTION_UNAUTHENTICATED:
         if (g_last_authenticated_time >= g_first_unauthenticated_time)
-- 
2.34.1

